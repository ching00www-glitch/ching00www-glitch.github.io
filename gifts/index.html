<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•è€äººå¾ˆå¿™ï¼šæ¥ç¦®ç‰©éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for children's game aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f1; /* Light teal/snowy background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border: 10px solid #c62828; /* Festive red border */
            border-radius: 20px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-board {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            /* èƒŒæ™¯åœ–ç‰‡: background.jpg.webp */
            background: url('background.jpg.webp') no-repeat center center / cover;
            overflow: hidden;
        }
        
        /* --- é›ªèŠ±æ•ˆæœ (Snow Effect) --- */
        .snow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5; /* Below background stars and items */
            /* Creating multiple layers of animated snow using radial gradients */
            background-image: 
                radial-gradient(rgba(255, 255, 255, 0.8) 1px, transparent 1px),
                radial-gradient(rgba(220, 220, 220, 0.6) 2px, transparent 2px),
                radial-gradient(rgba(240, 240, 240, 0.9) 1px, transparent 1px);
            background-size: 500px 500px, 300px 300px, 100px 100px;
            animation: snowFall 20s linear infinite;
        }

        @keyframes snowFall {
            from {
                background-position: 0 0, 0 0, 0 0;
            }
            to {
                /* Create the illusion of falling snow */
                background-position: 500px 500px, -300px 300px, 100px 100px;
            }
        }
        /* --- End Snow Effect --- */


        /* Santa and item styles */
        .santa {
            position: absolute;
            bottom: 2%; /* Move Santa up slightly from the very bottom edge */
            width: 10%;
            height: 10%;
            max-width: 80px;
            max-height: 80px;
            cursor: grab;
            user-select: none;
            text-align: center;
            z-index: 20;
        }
        /* Style for the player image within the santa container */
        .santa img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ç¢ºä¿åœ–ç‰‡åœ¨å®¹å™¨å…§å®Œæ•´é¡¯ç¤º */
        }

        .item {
            position: absolute;
            top: -50px;
            width: 8%;
            height: 8%;
            max-width: 60px;
            max-height: 60px;
            font-size: 3rem; /* ä¿æŒé€™å€‹å¤§å°ä»¥é©ç”¨æ–¼ Emoji (ç‚¸å½ˆ/é‡‘éŒ¢) */
            text-align: center;
            animation: fall linear forwards;
            user-select: none;
            z-index: 10;
        }
        
        /* æ‰è½ç‰©çš„åœ–ç‰‡æ¨£å¼ (ç”¨æ–¼ç¦®ç‰©åœ–ç‰‡) */
        .item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        @keyframes fall {
            to {
                transform: translateY(calc(100vh + 100px));
            }
        }
        
        /* Modal and Feedback Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none; 
        }

        .feedback-message {
            position: absolute;
            z-index: 50;
            font-size: 2.5rem; 
            font-weight: 900;
            color: #ffee58; 
            text-shadow: 3px 3px 5px #c62828; 
            animation: fadeOut 1.5s ease-out;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-70px) scale(0.8); }
        }

        /* Explosive effect for bombs */
        .explosion {
            position: absolute;
            width: 150px; 
            height: 150px;
            background-color: transparent;
            border-radius: 50%;
            font-size: 6rem;
            animation: explode 0.6s ease-out forwards;
            z-index: 60;
            pointer-events: none;
        }

        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; text-shadow: 0 0 10px orange; }
            50% { transform: scale(1.8); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* Burned Santa Feedback - Use Sad/Burned Emoji Combination */
        .burned-santa {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem; 
            animation: bounceIn 1s forwards;
            z-index: 70;
            pointer-events: none;
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Responsive adjustments for controls */
        .difficulty-btn {
            min-width: 100px;
        }
        @media (min-width: 768px) {
            .difficulty-btn {
                min-width: 150px;
            }
        }

    </style>
</head>
<body>

<audio id="bg-music" loop>
    <source src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Sample-MP3-File.mp3" type="audio/mpeg">
    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾ã€‚
</audio>

<div id="app" class="game-container">
    
    <div class="w-full p-4 bg-red-700 flex justify-around items-center rounded-t-xl text-white font-black text-xs md:text-2xl shadow-lg z-10">
        <div class="flex flex-col items-center">
            <span>å›åˆ ğŸŒŸ</span>
            <span id="level-display" class="text-2xl md:text-4xl text-green-300">1</span>
        </div>
        <div class="flex flex-col items-center">
            <span>ç¦®ç‰©åˆ†æ•¸ ğŸ</span>
            <span id="score-display" class="text-2xl md:text-4xl text-yellow-300">0</span>
        </div>
        <div class="flex flex-col items-center">
            <span>é‡‘éŒ¢ ğŸ’°</span>
            <span id="money-display" class="text-2xl md:text-4xl text-yellow-300">0</span>
        </div>
        <div class="flex flex-col items-center">
            <span>ç”Ÿå‘½å€¼ â¤ï¸</span>
            <span id="lives-display" class="text-2xl md:text-4xl text-red-300">3</span>
        </div>
        <div class="flex flex-col items-center">
            <span>è¨ˆæ™‚å™¨ â°</span>
            <span id="timer-display" class="text-2xl md:text-4xl text-green-300">60</span>
        </div>
    </div>

    <div id="game-board" class="game-board">
        <div class="snow"></div>
        <div id="santa" class="santa">
            <img src="player3.jpg" alt="éŠæˆ²è§’è‰²">
        </div>
        </div>
    
    <div class="w-full p-4 bg-green-800 flex flex-col md:flex-row justify-center items-center gap-2 rounded-b-xl shadow-lg">
        <div class="text-white font-black text-lg hidden md:block">é¸æ“‡æŒ‘æˆ°:</div>
        <button id="difficulty-easy" data-difficulty="easy" class="difficulty-btn bg-yellow-300 hover:bg-yellow-400 text-red-800 font-black py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">ç°¡å–® ğŸ¬</button>
        <button id="difficulty-medium" data-difficulty="medium" class="difficulty-btn bg-yellow-300 hover:bg-yellow-400 text-red-800 font-black py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">ä¸­ç­‰ ğŸ</button>
        <button id="difficulty-hard" data-difficulty="hard" class="difficulty-btn bg-yellow-300 hover:bg-yellow-400 text-red-800 font-black py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">å›°é›£ ğŸ’</button>
        
        <button id="main-restart-button" class="bg-purple-600 hover:bg-purple-700 text-white font-black py-2 px-6 rounded-full shadow-md transition transform hover:scale-105 md:ml-4">é‡æ–°é–‹å§‹ ğŸ”„</button>
    </div>

</div>

<div id="game-modal" class="modal">
    <div class="bg-white p-8 rounded-2xl text-center shadow-2xl max-w-sm w-11/12 border-8 border-red-500">
        <h2 id="modal-title" class="text-4xl font-black mb-4 text-green-700">éŠæˆ²æš«åœ</h2>
        <p id="modal-message" class="text-lg mb-6 text-gray-700">å›åˆçµæŸæˆ–éŠæˆ²çµæŸè¨Šæ¯ã€‚</p>
        <button id="modal-next-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 hidden">ä¸‹ä¸€å›åˆ</button>
        <button id="modal-restart-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 hidden">é‡æ–°é¸æ“‡é›£åº¦</button>
    </div>
</div>

<script>
    // --- Configuration and State Variables ---
    const config = {
        EASY: { interval: 1500, speed: 2.0, maxItems: 10, targetScore: 25, bombChance: 0.15 }, 
        MEDIUM: { interval: 1000, speed: 3.0, maxItems: 15, targetScore: 75, bombChance: 0.25 }, 
        HARD: { interval: 700, speed: 4.0, maxItems: 20, targetScore: 150, bombChance: 0.35 }
    };

    let gameState = {
        level: 1,
        score: 0, // ç¦®ç‰©åˆ†æ•¸ (ç”¨æ–¼éé—œç›®æ¨™)
        money: 0, // é‡‘éŒ¢ (ç¨ç«‹è¨ˆç®—)
        lives: 3,
        timer: 0,
        gameRunning: false,
        santaX: 50, 
        difficulty: 'easy', 
        maxScore: 200, 
        bombValue: 1,
        itemCount: 0,
        itemTimer: null,
        gameTimer: null,
        currentSpeed: 0,
        currentInterval: 0,
        currentTargetScore: 0,
    };
    
    // === MODIFICATION: æ‰è½ç¦®ç‰©åœ–ç‰‡åˆ—è¡¨ (ä½¿ç”¨ 1prize.jpg, 2prize.jpg, 3prize.jpg) ===
    const giftImages = [
        '1prize.jpg',
        '2prize.jpg',
        '3prize.jpg'
    ];

    // --- DOM Elements ---
    const gameBoard = document.getElementById('game-board');
    const santa = document.getElementById('santa');
    const scoreDisplay = document.getElementById('score-display');
    const moneyDisplay = document.getElementById('money-display'); // New element
    const livesDisplay = document.getElementById('lives-display');
    const timerDisplay = document.getElementById('timer-display');
    const levelDisplay = document.getElementById('level-display');
    const gameModal = document.getElementById('game-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalNextButton = document.getElementById('modal-next-button');
    const modalRestartButton = document.getElementById('modal-restart-button'); 
    const mainRestartButton = document.getElementById('main-restart-button');
    const difficultyButtons = document.querySelectorAll('.difficulty-btn');
    const bgMusic = document.getElementById('bg-music'); 
    
    const burnedSantaEmoji = 'ğŸ˜¢';
    
    // Continuous Movement Variables
    let keysPressed = {};
    let moveInterval = null;
    const MOVE_STEP = 3; // Percentage move step for continuous movement
    const MOVE_INTERVAL_MS = 30; // 33 FPS for movement

    // --- Utility Functions ---

    /**
     * Updates the UI elements based on the current gameState.
     */
    function updateUI() {
        scoreDisplay.textContent = gameState.score;
        moneyDisplay.textContent = gameState.money; // Update money display
        livesDisplay.textContent = gameState.lives;
        timerDisplay.textContent = gameState.timer;
        levelDisplay.textContent = gameState.level;
        santa.style.left = `${gameState.santaX}%`;

        // Update lives hearts
        const hearts = 'â¤ï¸'.repeat(gameState.lives) + 'ğŸ’”'.repeat(3 - gameState.lives);
        livesDisplay.innerHTML = hearts;
    }

    /**
     * Initializes game settings based on selected difficulty and current level.
     */
    function applyDifficulty(difficulty, level) {
        let baseConfig = config[difficulty.toUpperCase()];
        if (!baseConfig) return;
        const levelFactor = 1 + (level - 1) * 0.15;
        
        gameState.currentInterval = Math.max(200, baseConfig.interval / levelFactor);
        gameState.currentSpeed = baseConfig.speed * levelFactor;
        gameState.currentTargetScore = baseConfig.targetScore;
        gameState.currentBombChance = Math.min(0.7, baseConfig.bombChance * levelFactor);
    }
    
    /**
     * Resets the game state for a new round/level.
     */
    function resetGame(startNewGame = false) {
        stopGame();
        
        if (startNewGame) {
            gameState.level = 1;
            gameState.lives = 3;
            gameState.score = 0;
            gameState.money = 0; // Reset money on new game
            gameState.santaX = 50;
        }

        gameState.timer = 60;
        gameState.itemCount = 0;
        
        document.querySelectorAll('.item').forEach(item => item.remove());
        applyDifficulty(gameState.difficulty, gameState.level);
        updateUI();
    }

    /**
     * Handles the start of the game or next level.
     */
    function startGame() {
        gameModal.style.display = 'none';

        resetGame(false); 
        gameState.gameRunning = true;

        // Play music - usually requires prior user interaction
        bgMusic.volume = 0.5; 
        bgMusic.play().catch(e => console.log("Audio autoplay prevented. User interaction required.", e));

        gameState.itemTimer = setInterval(dropItem, gameState.currentInterval);

        gameState.gameTimer = setInterval(() => {
            gameState.timer--;
            if (gameState.timer <= 0) {
                endRound(true);
            }
            updateUI();
        }, 1000);

        requestAnimationFrame(checkCollisions);
    }

    /**
     * Stops all game loops (item dropping, timer, and movement).
     */
    function stopGame() {
        gameState.gameRunning = false;
        clearInterval(gameState.itemTimer);
        clearInterval(gameState.gameTimer);
        stopContinuousMovement(); // Stop keyboard movement
        bgMusic.pause(); 
    }

    /**
     * Creates and drops a new item (Gift, Coin, or Bomb).
     */
    function dropItem() {
        if (!gameState.gameRunning) return;
        
        const rand = Math.random();
        let isBomb = rand < gameState.currentBombChance;
        let itemType = 'gift'; // Default to gift
        let itemContent = ''; // Content can be image HTML or Emoji
        
        if (isBomb) {
            itemType = 'bomb';
            itemContent = 'ğŸ’£'; // Emoji
        } else {
            // 70% chance of point-giving gift, 30% chance of money
            if (rand < gameState.currentBombChance + (1 - gameState.currentBombChance) * 0.7) {
                // Gift for score (Image)
                itemType = 'gift';
                // éš¨æ©Ÿé¸æ“‡ä¸€å€‹ç¦®ç‰©åœ–ç‰‡
                const giftSrc = giftImages[Math.floor(Math.random() * giftImages.length)];
                itemContent = `<img src="${giftSrc}" alt="ç¦®ç‰©">`;
            } else {
                // Coin for money (Emoji)
                itemType = 'money';
                itemContent = 'ğŸ’°';
            }
        }

        const itemElement = document.createElement('div');
        itemElement.classList.add('item');

        const itemValue = Math.floor(Math.random() * 6) + 5; // 5 to 10 points/money
        
        itemElement.dataset.type = itemType;
        itemElement.dataset.value = itemValue;
        itemElement.innerHTML = itemContent; // Set content

        const startX = Math.random() * 90; 
        itemElement.style.left = `${startX}%`;

        const duration = gameBoard.offsetHeight / (gameState.currentSpeed * 50); 
        itemElement.style.animationDuration = `${duration}s`;
        
        itemElement.id = 'item-' + gameState.itemCount++;
        gameBoard.appendChild(itemElement);

        itemFall(itemElement);
    }

    /**
     * Tracks the falling item's position and checks for collisions.
     */
    function itemFall(item) {
        item.addEventListener('animationend', () => {
            if (gameBoard.contains(item)) {
                item.remove();
            }
        });
    }

    /**
     * Checks for collision between Santa and the items.
     */
    function checkCollisions() {
        requestAnimationFrame(checkCollisions);

        if (!gameState.gameRunning) {
             return;
        }

        const santaRect = santa.getBoundingClientRect();
        const items = document.querySelectorAll('.item');

        items.forEach(item => {
            if (!gameBoard.contains(item)) return; 
            
            const itemRect = item.getBoundingClientRect();

            if (
                itemRect.bottom > santaRect.top &&
                itemRect.top < santaRect.bottom &&
                itemRect.right > santaRect.left &&
                itemRect.left < santaRect.right
            ) {
                handleCollision(item);
            }
        });
    }

    /**
     * Handles the outcome of Santa catching an item.
     */
    function handleCollision(item) {
        const type = item.dataset.type;
        const value = parseInt(item.dataset.value);
        const phrases = ['å¤ªæ£’äº†!', 'å¥½æº–!', 'è–èª•å¿«æ¨‚!', 'å®Œç¾!', 'è€¶!'];
        const praise = phrases[Math.floor(Math.random() * phrases.length)];

        item.remove(); 
        
        if (type === 'gift' || type === 'money') {
            if (type === 'gift') {
                // Gift gives Score (for level progression)
                gameState.score = Math.min(gameState.maxScore, gameState.score + value);
                showFeedback(`ğŸ‰ ${praise} +${value}åˆ†`, santa.offsetLeft + santa.offsetWidth / 2, item.offsetTop);
            } else if (type === 'money') {
                // Coin gives Money (separate currency)
                gameState.money += value;
                showFeedback(`ğŸ’µ æ”¶åˆ°é‡‘éŒ¢ +${value}`, santa.offsetLeft + santa.offsetWidth / 2, item.offsetTop);
            }
        } else if (type === 'bomb') {
            gameState.lives = Math.max(0, gameState.lives - 1);
            showBombFeedback(item.offsetLeft, item.offsetTop);
        }

        updateUI();

        if (gameState.lives <= 0) {
            endRound(false); 
        }
    }

    /**
     * Shows positive text feedback from Santa.
     */
    function showFeedback(text, x, y) {
        const feedback = document.createElement('div');
        feedback.classList.add('feedback-message');
        feedback.textContent = text;
        
        const boardRect = gameBoard.getBoundingClientRect();
        const relativeX = x - boardRect.left;
        const relativeY = y - boardRect.top;

        feedback.style.left = `${relativeX}px`;
        feedback.style.top = `${relativeY}px`;
        gameBoard.appendChild(feedback);

        setTimeout(() => feedback.remove(), 1500);
    }

    /**
     * Shows bomb hit effects.
     */
    function showBombFeedback(x, y) {
        const explosion = document.createElement('div');
        explosion.classList.add('explosion');
        explosion.innerHTML = 'ğŸ’¥';
        
        const boardRect = gameBoard.getBoundingClientRect();
        const relativeX = x - boardRect.left;
        const relativeY = y - boardRect.top;

        explosion.style.left = `${relativeX}px`;
        explosion.style.top = `${relativeY}px`;
        gameBoard.appendChild(explosion);

        const burnedSanta = document.createElement('div');
        burnedSanta.classList.add('burned-santa');
        burnedSanta.innerHTML = `${burnedSantaEmoji} ğŸ”¥`; 
        gameBoard.appendChild(burnedSanta);

        setTimeout(() => explosion.remove(), 600);
        setTimeout(() => burnedSanta.remove(), 1000);
    }
    
    /**
     * Handles the end of a round, either by timer or running out of lives.
     */
    function endRound(timerExpired) {
        stopGame();
        
        let message = '';
        let title = '';
        
        if (gameState.lives <= 0) {
            title = 'éŠæˆ²çµæŸï¼';
            message = `æ‚¨æ¥åˆ°äº† ${gameState.score} ç¦®ç‰©åˆ†æ•¸å’Œ ${gameState.money} é‡‘éŒ¢ã€‚å¤ªå¯æƒœäº†ï¼`;
            modalNextButton.classList.add('hidden');
            modalRestartButton.classList.remove('hidden');
        } else if (timerExpired) {
            if (gameState.score >= gameState.currentTargetScore) {
                title = 'å¤ªæ£’äº†ï¼ å›åˆå®Œæˆï¼';
                message = `æ­å–œï¼æ‚¨ç²å¾—äº† ${gameState.score} ç¦®ç‰©åˆ†æ•¸å’Œ ${gameState.money} é‡‘éŒ¢ã€‚æˆåŠŸé”åˆ° ${gameState.currentTargetScore} åˆ†çš„ç›®æ¨™ï¼æº–å‚™æŒ‘æˆ°ç¬¬ ${gameState.level + 1} å›åˆï¼`;
                modalNextButton.classList.remove('hidden');
                modalRestartButton.classList.add('hidden');
                gameState.level++; 
            } else {
                title = 'æŒ‘æˆ°å¤±æ•—ï¼';
                message = `æ™‚é–“åˆ°ï¼æ‚¨åªç²å¾—äº† ${gameState.score} ç¦®ç‰©åˆ†æ•¸ï¼Œæœªé”åˆ° ${gameState.currentTargetScore} åˆ†çš„ç›®æ¨™ã€‚è«‹å†è©¦ä¸€æ¬¡ï¼`;
                modalNextButton.classList.add('hidden');
                modalRestartButton.classList.remove('hidden');
            }
        }

        modalTitle.textContent = title;
        modalMessage.innerHTML = message; 
        gameModal.style.display = 'flex'; 
    }

    /**
     * Handles keyboard down event to start continuous movement.
     */
    function handleKeyDown(e) {
        if (!gameState.gameRunning) return;
        
        const key = e.key.toLowerCase();
        if (key === 'arrowleft' || key === 'a' || key === 'arrowright' || key === 'd') {
            keysPressed[key] = true;
            startContinuousMovement();
            e.preventDefault(); // Prevent default browser actions
        }
    }

    /**
     * Handles keyboard up event to stop continuous movement.
     */
    function handleKeyUp(e) {
        const key = e.key.toLowerCase();
        if (key === 'arrowleft' || key === 'a' || key === 'arrowright' || key === 'd') {
            delete keysPressed[key];
            if (Object.keys(keysPressed).length === 0) {
                stopContinuousMovement();
            }
        }
    }

    /**
     * Starts the interval for continuous Santa movement.
     */
    function startContinuousMovement() {
        if (moveInterval) return; 

        moveInterval = setInterval(() => {
            let moved = false;
            
            if (keysPressed['arrowleft'] || keysPressed['a']) {
                gameState.santaX = Math.max(0, gameState.santaX - MOVE_STEP);
                moved = true;
            } else if (keysPressed['arrowright'] || keysPressed['d']) {
                // Max position is 100% minus Santa's width (10%)
                gameState.santaX = Math.min(90, gameState.santaX + MOVE_STEP);
                moved = true;
            }

            if (moved) {
                updateUI();
            }
        }, MOVE_INTERVAL_MS);
    }

    /**
     * Stops the interval for continuous Santa movement.
     */
    function stopContinuousMovement() {
        clearInterval(moveInterval);
        moveInterval = null;
    }

    /**
     * Sets the default easy difficulty and starts the game.
     */
    function initialSetup() {
        // é è¨­é¸æ“‡ã€Œç°¡å–®ã€æŒ‰éˆ•
        difficultyButtons.forEach(btn => btn.classList.remove('ring-4', 'ring-red-500'));
        document.getElementById('difficulty-easy').classList.add('ring-4', 'ring-red-500');

        gameState.difficulty = 'easy';
        gameState.level = 1;
        gameState.lives = 3;
        gameState.score = 0;
        gameState.money = 0;
        
        startGame(); // ç›´æ¥é–‹å§‹éŠæˆ²
    }

    /**
     * Function to handle the main Restart button click.
     */
    function restartGameFlow() {
        // é‡è¨­éŠæˆ²ç‹€æ…‹ï¼Œä½†ä¿ç•™ç•¶å‰é¸æ“‡çš„é›£åº¦
        stopGame();
        resetGame(true); 
        startGame(); 
    }


    // --- Event Listeners Initialization ---

    // 1. Difficulty Selection - Now starts the game immediately with new difficulty
    difficultyButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Highlight the selected difficulty button
            difficultyButtons.forEach(btn => btn.classList.remove('ring-4', 'ring-red-500'));
            button.classList.add('ring-4', 'ring-red-500');

            gameState.difficulty = button.dataset.difficulty;
            
            // Start a brand new game (reset all states) with the chosen difficulty
            resetGame(true); 
            startGame();
        });
    });

    // 2. Modal Button Handlers (Only visible on Game Over / Level Up)
    modalNextButton.addEventListener('click', startGame); 
    modalRestartButton.addEventListener('click', initialSetup); // Game Over/Fail: å›åˆ°ç°¡å–®é›£åº¦é‡è¨­

    // 3. Main Control Panel Restart Button
    mainRestartButton.addEventListener('click', restartGameFlow);

    // 4. Santa Movement (Keyboard - Continuous)
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);

    // 5. Santa Movement (Touch - iPad/Mobile)
    let touchStartX = 0;
    let santaStartPos = 0;
    let isDragging = false;
    
    gameBoard.addEventListener('touchstart', (e) => {
        if (!gameState.gameRunning || e.touches.length !== 1) return;
        
        const santaRect = santa.getBoundingClientRect();
        const touchY = e.touches[0].clientY;
        
        // Check if touch started near Santa
        if (touchY > santaRect.top && touchY < santaRect.bottom + 50) {
             e.preventDefault();
             isDragging = true;
             touchStartX = e.touches[0].clientX;
             santaStartPos = gameState.santaX;
        }

    }, { passive: false });

    gameBoard.addEventListener('touchmove', (e) => {
        if (!gameState.gameRunning || !isDragging || e.touches.length !== 1) return;
        e.preventDefault();
        
        const currentX = e.touches[0].clientX;
        const deltaX = currentX - touchStartX;
        
        const boardWidth = gameBoard.offsetWidth;
        const percentageChange = (deltaX / boardWidth) * 100;
        
        let newX = santaStartPos + percentageChange;
        
        gameState.santaX = Math.min(90, Math.max(0, newX));
        updateUI();
    }, { passive: false });

    gameBoard.addEventListener('touchend', () => {
        isDragging = false;
    });
    
    // 6. Initialize Game
    window.onload = function() {
        santa.style.left = `${gameState.santaX}%`;
        checkCollisions(); 
        
        // éŠæˆ²è¼‰å…¥å®Œæˆå¾Œï¼Œç«‹å³ä»¥é è¨­é›£åº¦ï¼ˆç°¡å–®ï¼‰é–‹å§‹
        initialSetup();
    }
</script>
</body>
</html>
